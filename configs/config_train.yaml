defaults:
  - _self_
  - /callbacks: [checkpoint_every_n_steps, checkpoint_monitor, learning_rate_monitor]
  - /model: small
  - /strategy: ddp
  - /noise: loglinear
  - /lr_scheduler: three_phase
  - /algo: bd3lm

mode: train  # train / sample_eval
diffusion: absorbing_state

seed: 42

block_size: ${model.length}

loader:
  data_dir: /data_133/rtq/Dataset/DIV2K/DIV2K_LR_unified/X4
  global_batch_size: 512
  eval_global_batch_size: ${.global_batch_size}
  # Note: batch_size and eval_batch_size are **per machine**
  batch_size: ${div_up:${.global_batch_size}, ${eval:${trainer.devices} * ${trainer.num_nodes}}}
  eval_batch_size: ${div_up:${.eval_global_batch_size}, ${eval:${trainer.devices} * ${trainer.num_nodes}}}
  num_workers: 0
  pin_memory: True

data:
  is_channel_wised: True  # RGB False; Gray True
  tokenizer_name_or_path: /data_133/rtq/Model/gpt2

training:
  from_pretrained: /data_133/rtq/Model/bd3lm/bd3lm-owt-block_size1024-pretrain
  ema: 0.9999
  sampling_eps: 1e-3
  sampling_eps_min: 0.35
  sampling_eps_max: 0.85
  resample: False

optim:
  lr: 1e-4
  beta1: 0.9
  beta2: 0.999
  eps: 1e-8
  weight_decay: 1e-2

trainer:
  _target_: lightning.Trainer
  accelerator: cuda
  num_nodes: 1
  devices: ${device_count:}
  accumulate_grad_batches: ${div_up:${loader.global_batch_size}, ${eval:${trainer.devices} * ${loader.batch_size} * ${trainer.num_nodes}}}
  gradient_clip_val: 1.0
  precision: 'bf16-mixed'
  num_sanity_val_steps: 2
  max_steps: 10360           # ~10 epochs
  log_every_n_steps: 1
  limit_train_batches: 1.0   # train on full dataset, can be used to toggle quick run
  limit_val_batches: 1.0     # validate on full dataset, can be used to toggle quick run
  val_check_interval: 6630   # validate every N training steps

wandb:
  project: BD3-LMs
  notes: Block Denoising Discrete Diffusion Language Models
  group: null
  job_type: null
  name: null
  id: ${.name}-time${now:%Y%m%d%H%M}
  tags:
    - ${noise.type}

hydra:
  run:
    dir: ./outputs/train/${now:%Y.%m.%d}/${now:%H%M%S}
  job:
    chdir: true

checkpointing:
  # Use custom `save_dir` if, e.g., saving to S3 bucket, otherwise leave this parameter as is
  save_dir: ${cwd:}
  # Note: `checkpoints` path should correspond to `checkpoint_every_n_steps.dirpath`
  resume_from_ckpt: False
  resume_ckpt_path: /data_133/rtq/BD3LM-SSCC/outputs/train/2026.01.29/152740/checkpoints/last.ckpt